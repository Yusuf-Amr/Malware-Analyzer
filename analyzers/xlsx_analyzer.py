import openpyxl
from .base_analyzer import BaseAnalyzer
from utils.hash_calculator import calculate_file_hash
import subprocess

class XLSXAnalyzer(BaseAnalyzer):
    def extract_metadata(self, workbook):
        properties = workbook.properties
        metadata = {
            'author': properties.creator,
            'title': properties.title,
            'subject': properties.subject,
            'keywords': properties.keywords,
            'last_modified_by': properties.last_modified_by,
            'revision': properties.revision,
            'created': properties.created,
            'modified': properties.modified,
        }
        return metadata

    def run_command(self, command):
        try:
            output = subprocess.check_output(command, shell=True, text=True)
        except subprocess.CalledProcessError as e:
            output = e.output
        return output

    def analyze(self):
        try:
            workbook = openpyxl.load_workbook(self.file_path)
            sheets = {sheet.title: [[cell.value for cell in row] for row in sheet.iter_rows()] for sheet in workbook}

            metadata = self.extract_metadata(workbook)
            oleid_output = self.run_command(f"oleid {self.file_path}")
            olevba_output = self.run_command(f"olevba {self.file_path}")
            mraptor_output = self.run_command(f"mraptor {self.file_path}")

            return {
                'file_path': self.file_path,
                'file_hash': calculate_file_hash(self.file_path),
                'sheets': sheets,
                'metadata': metadata,
                'oleid_output': oleid_output,
                'olevba_output': olevba_output,
                'mraptor_output': mraptor_output
            }
        except Exception as e:
            return {
                'file_path': self.file_path,
                'error': str(e),
            }
